<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cono de Abrams | Studio Premium</title>

    <!-- Google Fonts: Arquitectónicas y Limpias -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600&family=Inter:wght@300;400;500&display=swap" rel="stylesheet">
    
    <!-- Three.js & OrbitControls -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.134.0/examples/js/controls/OrbitControls.js"></script>

    <style>
        :root {
            /* Paleta Minimalista "White-Lab" */
            --bg-main: #f4f7f6;
            --bg-panel: #ffffff;
            --text-main: #2c3e50;
            --text-muted: #7f8c8d;
            --accent-blue: #3498db;
            --accent-dark: #1a252f;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --border-light: #e2e8f0;
            --shadow-soft: 0 10px 30px rgba(44, 62, 80, 0.05);
            --shadow-float: 0 15px 35px rgba(44, 62, 80, 0.1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-main);
            width: 100vw; height: 100vh; overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* HEADER */
        .header {
            display: flex; justify-content: space-between; align-items: center; padding: 0 30px;
            background: var(--bg-panel); border-bottom: 1px solid var(--border-light);
            height: 70px; z-index: 20; box-shadow: 0 2px 10px rgba(0,0,0,0.02);
        }
        .brand { display: flex; align-items: center; gap: 15px; }
        .logo-icon { width: 24px; height: 24px; fill: var(--text-main); }
        .logo-text { font-family: 'Montserrat', sans-serif; font-size: 18px; font-weight: 600; letter-spacing: 1px; color: var(--accent-dark); }
        .subtitle { font-family: 'Inter'; font-size: 12px; color: var(--text-muted); font-weight: 400; letter-spacing: 0.5px;}
        
        /* PROGRESO MINIMALISTA */
        .progress-wrapper { flex-grow: 1; max-width: 500px; margin: 0 40px; display: flex; align-items: center; gap: 8px; }
        .progress-line { height: 2px; flex: 1; background: var(--border-light); transition: all 0.4s ease; }
        .progress-line.active { background: var(--accent-blue); }

        /* MAIN LAYOUT */
        .main-container { display: flex; flex: 1; position: relative; overflow: hidden; }

        /* SIDEBAR */
        .sidebar {
            width: 360px; background: var(--bg-panel); border-right: 1px solid var(--border-light);
            display: flex; flex-direction: column; padding: 30px; z-index: 10;
            box-shadow: 5px 0 20px rgba(0,0,0,0.02); overflow-y: auto;
        }
        .sidebar::-webkit-scrollbar { width: 4px; }
        .sidebar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 2px; }

        .section-header { font-family: 'Montserrat', sans-serif; font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 20px; border-bottom: 1px solid var(--border-light); padding-bottom: 8px;}

        /* SLIDERS ELEGANTES */
        .control-group { margin-bottom: 25px; }
        .control-label { display: flex; justify-content: space-between; font-size: 13px; font-weight: 500; margin-bottom: 12px; color: var(--text-main); }
        .control-value { color: var(--accent-blue); font-weight: 600; font-family: 'Montserrat', sans-serif; }
        
        input[type=range] { -webkit-appearance: none; width: 100%; background: #e2e8f0; height: 2px; border-radius: 1px; outline: none; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 16px; height: 16px; border-radius: 50%; background: #fff;
            border: 2px solid var(--accent-blue); cursor: pointer; box-shadow: 0 2px 5px rgba(52, 152, 219, 0.2); transition: transform 0.2s;
        }
        input[type=range]::-webkit-slider-thumb:hover { transform: scale(1.2); }
        input[type=range]:disabled { opacity: 0.5; cursor: not-allowed; }

        /* BARRAS REOLOGÍA */
        .rheo-item { margin-bottom: 12px; }
        .rheo-header { display: flex; justify-content: space-between; font-size: 11px; color: var(--text-muted); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;}
        .rheo-track { width: 100%; height: 3px; background: #f1f5f9; border-radius: 1.5px; overflow: hidden; }
        .rheo-fill { height: 100%; transition: width 0.4s ease, background-color 0.4s; }

        /* CONSOLA / LOG */
        .log-container {
            flex-grow: 1; min-height: 120px; background: #f8fafc; border: 1px solid var(--border-light);
            border-radius: 6px; padding: 15px; font-size: 12px; color: var(--text-main); line-height: 1.5;
            overflow-y: auto; display: flex; flex-direction: column; gap: 8px; margin-bottom: 20px;
        }
        .log-entry { opacity: 0; animation: fadeInLog 0.3s forwards; }
        .log-info { border-left: 2px solid var(--accent-blue); padding-left: 8px; }
        .log-success { border-left: 2px solid var(--success); padding-left: 8px; color: var(--success); }
        .log-warning { border-left: 2px solid var(--warning); padding-left: 8px; color: #b9770e; }
        @keyframes fadeInLog { to { opacity: 1; } }

        /* BOTÓN PRINCIPAL */
        .btn-primary {
            width: 100%; padding: 16px; background: var(--accent-dark); color: #fff;
            border: none; border-radius: 6px; font-family: 'Montserrat', sans-serif; font-size: 13px; font-weight: 600;
            letter-spacing: 1px; text-transform: uppercase; cursor: pointer; transition: all 0.2s ease;
            box-shadow: 0 4px 15px rgba(26, 37, 47, 0.15); display: flex; justify-content: center; align-items: center; gap: 10px;
        }
        .btn-primary:hover:not(:disabled) { background: #2c3e50; transform: translateY(-2px); box-shadow: 0 6px 20px rgba(26, 37, 47, 0.2); }
        .btn-primary:active:not(:disabled) { transform: translateY(0); }
        .btn-primary:disabled { background: #cbd5e1; color: #94a3b8; box-shadow: none; cursor: not-allowed; }
        .btn-action { background: var(--accent-blue); box-shadow: 0 4px 15px rgba(52, 152, 219, 0.2); }
        .btn-action:hover:not(:disabled) { background: #2980b9; }

        /* 3D SCENE CONTAINER */
        #scene-wrapper { flex: 1; position: relative; background: radial-gradient(circle at center, #ffffff 0%, #e2e8f0 100%); }
        #canvas-container { width: 100%; height: 100%; position: absolute; top: 0; left: 0; outline: none; }

        /* HUD FLOTANTE (Minimalista) */
        .hud-layer { position: absolute; top: 30px; left: 30px; right: 30px; pointer-events: none; display: flex; justify-content: space-between; z-index: 5; }
        .hud-panel {
            background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.5); border-radius: 8px; padding: 15px 25px;
            box-shadow: var(--shadow-soft); display: flex; flex-direction: column; align-items: flex-start; min-width: 150px;
        }
        .hud-label { font-size: 10px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; }
        .hud-value { font-family: 'Montserrat', sans-serif; font-size: 22px; font-weight: 500; color: var(--accent-dark); }
        .hud-value.highlight { color: var(--accent-blue); font-weight: 600; }

        /* AVATAR PROFESOR SVG (Minimalista Lineal) */
        .instructor-widget { position: absolute; bottom: 30px; left: 30px; display: flex; align-items: flex-end; gap: 20px; z-index: 10; pointer-events: none;}
        .avatar-svg { width: 70px; height: 70px; stroke: var(--text-main); stroke-width: 1.5; fill: none; stroke-linecap: round; stroke-linejoin: round; transition: transform 0.3s; }
        .avatar-svg.speaking { animation: subtleBob 2s infinite ease-in-out; }
        @keyframes subtleBob { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-4px); } }
        
        .speech-bubble {
            background: #fff; padding: 15px 20px; border-radius: 8px 8px 8px 0; font-size: 13px; color: var(--text-main);
            box-shadow: var(--shadow-float); max-width: 280px; line-height: 1.5; position: relative; border: 1px solid var(--border-light);
            animation: fadeInBubble 0.3s ease-out;
        }
        @keyframes fadeInBubble { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* PANEL DE RESULTADOS (Modal Elegante) */
        .results-modal {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(244, 247, 246, 0.8);
            backdrop-filter: blur(8px); display: flex; justify-content: center; align-items: center; z-index: 50;
            opacity: 0; pointer-events: none; transition: opacity 0.4s ease;
        }
        .results-modal.active { opacity: 1; pointer-events: auto; }
        .results-content {
            background: #fff; border-radius: 12px; padding: 40px; width: 450px; box-shadow: var(--shadow-float);
            transform: translateY(20px); transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); border: 1px solid var(--border-light);
        }
        .results-modal.active .results-content { transform: translateY(0); }
        
        .res-header { text-align: center; margin-bottom: 30px; }
        .res-title { font-family: 'Montserrat', sans-serif; font-size: 20px; font-weight: 600; color: var(--accent-dark); margin-bottom: 5px; }
        .res-subtitle { font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }
        
        .res-main-val { text-align: center; font-family: 'Montserrat', sans-serif; font-size: 48px; font-weight: 300; color: var(--accent-blue); margin-bottom: 10px; }
        .res-type-badge { display: inline-block; padding: 6px 15px; border-radius: 20px; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; margin: 0 auto 30px auto; display: table;}
        .type-VERDADERO { background: #e8f5e9; color: var(--success); }
        .type-CORTADO { background: #fff8e1; color: var(--warning); }
        .type-COLAPSO { background: #ffebee; color: var(--danger); }

        .res-details { border-top: 1px solid var(--border-light); padding-top: 20px; margin-bottom: 30px; }
        .res-row { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 13px; }
        .res-lbl { color: var(--text-muted); }
        .res-val { font-weight: 500; color: var(--text-main); }
        
        .res-conclusion { background: #f8fafc; padding: 15px; border-radius: 6px; font-size: 13px; line-height: 1.5; color: var(--text-main); border-left: 3px solid var(--accent-blue); }

        /* Etiquetas 3D Flotantes */
        .label-3d { position: absolute; transform: translate(-50%, -50%); font-family: 'Inter', sans-serif; font-size: 12px; font-weight: 500; color: var(--text-muted); pointer-events: none; transition: opacity 0.2s; }
        .label-hit { font-family: 'Montserrat'; font-size: 20px; font-weight: 600; color: var(--accent-blue); animation: floatUpText 0.6s forwards; text-shadow: 0 2px 5px rgba(255,255,255,0.8);}
        .label-slump { font-family: 'Montserrat'; font-size: 28px; font-weight: 300; color: var(--accent-dark); background: rgba(255,255,255,0.8); padding: 5px 10px; border-radius: 4px; backdrop-filter: blur(4px); border: 1px solid var(--border-light);}
        @keyframes floatUpText { 0% { opacity: 1; transform: translate(-50%, -50%); } 100% { opacity: 0; transform: translate(-50%, -100%); } }
    </style>
</head>
<body>

    <!-- HEADER -->
    <header class="header">
        <div class="brand">
            <svg class="logo-icon" viewBox="0 0 24 24">
                <path d="M12 2L2 22h20L12 2zm0 3.8l7.1 14.2H4.9L12 5.8z"/>
                <rect x="11" y="10" width="2" height="6"/>
                <circle cx="12" cy="18" r="1.5"/>
            </svg>
            <div>
                <div class="logo-text">CONO DE ABRAMS</div>
                <div class="subtitle">Laboratorio de Materiales EHE-08</div>
            </div>
        </div>
        
        <div class="progress-wrapper">
            <div class="progress-line active"></div><div class="progress-line"></div>
            <div class="progress-line"></div><div class="progress-line"></div>
            <div class="progress-line"></div><div class="progress-line"></div>
            <div class="progress-line"></div>
        </div>
    </header>

    <div class="main-container">
        <!-- SIDEBAR -->
        <aside class="sidebar">
            <div class="section-header">Configuración de Mezcla</div>
            
            <div class="control-group">
                <div class="control-label"><span>Relación Agua/Cemento</span> <span class="control-value" id="val-wc">0.50</span></div>
                <input type="range" id="param-wc" min="0.30" max="0.80" step="0.01" value="0.50">
            </div>
            
            <div class="control-group">
                <div class="control-label"><span>Tamaño Máx. Árido</span> <span class="control-value" id="val-agg">20 mm</span></div>
                <input type="range" id="param-agg" min="10" max="40" step="1" value="20">
            </div>
            
            <div class="control-group" style="margin-bottom: 30px;">
                <div class="control-label"><span>Aditivo Plastificante</span> <span class="control-value" id="val-adit">0.0 %</span></div>
                <input type="range" id="param-adit" min="0" max="2" step="0.1" value="0.0">
            </div>

            <div class="section-header">Análisis Reológico Aproximado</div>
            
            <div class="rheo-item">
                <div class="rheo-header"><span>Viscosidad Aparente</span> <span id="lbl-vis">Alta</span></div>
                <div class="rheo-track"><div class="rheo-fill" id="bar-vis" style="width: 80%; background: #94a3b8;"></div></div>
            </div>
            <div class="rheo-item">
                <div class="rheo-header"><span>Cohesión Interna</span> <span id="lbl-coh">Media</span></div>
                <div class="rheo-track"><div class="rheo-fill" id="bar-coh" style="width: 50%; background: #cbd5e1;"></div></div>
            </div>
            <div class="rheo-item" style="margin-bottom: 30px;">
                <div class="rheo-header"><span>Fluidez (Workability)</span> <span id="lbl-flu">Baja</span></div>
                <div class="rheo-track"><div class="rheo-fill" id="bar-flu" style="width: 30%; background: var(--accent-blue);"></div></div>
            </div>

            <div class="section-header">Registro del Ensayo</div>
            <div class="log-container" id="logger"></div>

            <div style="display: flex; gap: 10px; margin-bottom: 15px; font-size: 11px; align-items: center; color: var(--text-muted);">
                <span>Velocidad de Izado:</span>
                <input type="range" id="param-speed" min="1" max="10" step="0.5" value="5.0" style="flex:1;">
                <span id="val-speed" style="font-weight:600; color:var(--text-main);">5.0s</span>
            </div>

            <button class="btn-primary" id="btn-action">INICIAR ENSAYO</button>
        </aside>

        <!-- 3D SCENE -->
        <main id="scene-wrapper">
            <div id="canvas-container"></div>
            
            <div class="hud-layer">
                <div class="hud-panel">
                    <span class="hud-label">Estado</span>
                    <span class="hud-value highlight" id="hud-phase">Preparación</span>
                </div>
                <div style="display: flex; gap: 15px;">
                    <div class="hud-panel">
                        <span class="hud-label">Compactación</span>
                        <span class="hud-value" id="hud-strokes">0 / 25</span>
                    </div>
                    <div class="hud-panel">
                        <span class="hud-label">Asiento final</span>
                        <div style="display: flex; align-items: baseline; gap: 4px;">
                            <span class="hud-value" id="hud-slump">--</span>
                            <span style="font-size: 12px; color: var(--text-muted); font-weight: 500;">mm</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="instructor-widget">
                <!-- SVG Avatar Minimalista (Ingeniero Lineal) -->
                <svg class="avatar-svg speaking" id="avatar" viewBox="0 0 100 100">
                    <!-- Hombros/Cuerpo -->
                    <path d="M20 100 C20 70, 80 70, 80 100" />
                    <!-- Cuello -->
                    <path d="M42 70 L42 60 M58 70 L58 60" />
                    <!-- Cara -->
                    <path d="M35 50 C35 65, 65 65, 65 50 C65 35, 35 35, 35 50 Z" />
                    <!-- Gafas -->
                    <rect x="38" y="44" width="10" height="6" rx="2" />
                    <rect x="52" y="44" width="10" height="6" rx="2" />
                    <line x1="48" y1="47" x2="52" y2="47" />
                    <!-- Casco de Obra -->
                    <path d="M30 40 C30 20, 70 20, 70 40 L75 40 L75 45 L25 45 L25 40 Z" />
                    <!-- Detalle casco -->
                    <path d="M50 22 L50 35" />
                </svg>
                <div class="speech-bubble" id="speech">
                    Parámetros listos. Verifica la configuración de la mezcla en el panel lateral y pulsa "Iniciar Ensayo".
                </div>
            </div>
            
            <div id="labels-container" style="position: absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; overflow:hidden;"></div>
        </main>

        <!-- MODAL DE RESULTADOS -->
        <div class="results-modal" id="modal-results">
            <div class="results-content">
                <div class="res-header">
                    <div class="res-subtitle">Ensayo Completado</div>
                    <div class="res-title">Dictamen Técnico</div>
                </div>
                
                <div class="res-main-val" id="res-val-big">120 mm</div>
                <div class="res-type-badge type-VERDADERO" id="res-type-badge">ASIENTO VERDADERO</div>
                
                <div class="res-details">
                    <div class="res-row"><span class="res-lbl">Clase de Consistencia Normativa:</span> <span class="res-val" id="res-class">S3 (Blanda)</span></div>
                    <div class="res-row"><span class="res-lbl">Tolerancia aplicable:</span> <span class="res-val">± 20 mm</span></div>
                    <div class="res-row"><span class="res-lbl">Relación Agua/Cemento ensayada:</span> <span class="res-val" id="res-wc-used">0.50</span></div>
                </div>
                
                <div class="res-conclusion" id="res-interp">
                    Hormigón apto para pilares y forjados estructurales convencionales. Requiere vibrado normal en obra.
                </div>
                
                <button class="btn-primary" id="btn-reset" style="margin-top: 30px; background: var(--text-main);">NUEVO ENSAYO</button>
            </div>
        </div>
    </div>

    <script>
        /**
         * SIMULADOR CONO DE ABRAMS - ARQUITECTURA CLEAN
         * Three.js r134 - Física Procedural Bingham - UX Minimalista
         */

        // ==========================================
        // CONSTANTES GEOMÉTRICAS EXACTAS (METROS)
        // Para evitar Z-Fighting, el hormigón es 1mm más pequeño que el molde hueco.
        // ==========================================
        const MOLD = { H: 0.300, R_BASE: 0.100, R_TOP: 0.050 };
        const CONC = { H: 0.300, R_BASE: 0.099, R_TOP: 0.049 };
        const PHASES = { SETUP: 0, L1: 1, L2: 2, L3: 3, STRIKE: 4, LIFT: 5, RESULT: 6 };

        const wait = ms => new Promise(res => setTimeout(res, ms));

        // ==========================================
        // MOTOR FÍSICO (Bingham Reology Approx)
        // ==========================================
        class PhysicsCore {
            static analyze(wc, agg, adit, speed) {
                // Fluidez empírica
                let fluidity = (wc - 0.3) * 2.2 + (adit * 0.9);
                let viscosity = Math.max(0.1, 1.0 - fluidity);
                let cohesion = (35 / agg) * (1.0 - adit * 0.4);
                
                let slumpMM = 5 + (fluidity * 210);
                slumpMM = Math.max(0, Math.min(290, slumpMM));

                // Diagnóstico de Fallo
                let type = 'VERDADERO';
                if (speed < 2.5 && fluidity > 0.5) type = 'CORTADO';
                if (slumpMM > 230 || (cohesion < 0.25 && fluidity > 0.8)) type = 'COLAPSO';
                
                // Penalización estructural visual
                if (type === 'CORTADO') slumpMM += 15;
                if (type === 'COLAPSO') slumpMM += 35;
                slumpMM = Math.min(300, slumpMM);

                return { slumpMM, slumpM: slumpMM/1000, type, fluidity, viscosity, cohesion };
            }
        }

        // ==========================================
        // CONTROLADOR DE INTERFAZ DOM
        // ==========================================
        class UI {
            constructor() {
                this.btn = document.getElementById('btn-action');
                this.labels = document.getElementById('labels-container');
                this.logEl = document.getElementById('logger');
                this.bindInputs();
            }

            bindInputs() {
                ['wc', 'agg', 'adit', 'speed'].forEach(id => {
                    document.getElementById(`param-${id}`).addEventListener('input', e => {
                        let v = parseFloat(e.target.value);
                        let text = v;
                        if(id==='wc') text = v.toFixed(2);
                        if(id==='agg') text += ' mm';
                        if(id==='adit') text += ' %';
                        if(id==='speed') text = v.toFixed(1) + 's';
                        document.getElementById(`val-${id}`).innerText = text;
                        this.updateRheology();
                    });
                });
                this.updateRheology();
            }

            updateRheology() {
                const p = PhysicsCore.analyze(
                    parseFloat(document.getElementById('param-wc').value),
                    parseFloat(document.getElementById('param-agg').value),
                    parseFloat(document.getElementById('param-adit').value),
                    5.0
                );
                
                const updateBar = (id, val, colors) => {
                    const norm = Math.max(0.05, Math.min(1, val));
                    document.getElementById(`bar-${id}`).style.width = `${norm * 100}%`;
                    let text = norm < 0.35 ? 'Baja' : norm < 0.7 ? 'Media' : 'Alta';
                    document.getElementById(`lbl-${id}`).innerText = text;
                    // Cambio de color sutil arquitectónico
                    document.getElementById(`bar-${id}`).style.background = norm < 0.35 ? colors[0] : norm < 0.7 ? colors[1] : colors[2];
                };

                updateBar('vis', p.viscosity, ['#94a3b8', '#64748b', '#334155']);
                updateBar('coh', p.cohesion, ['#94a3b8', '#64748b', '#334155']);
                updateBar('flu', p.fluidity, ['#cbd5e1', '#94a3b8', '#3498db']);
            }

            log(msg, type='info') {
                const el = document.createElement('div');
                el.className = `log-entry log-${type}`;
                el.innerText = `• ${msg}`;
                this.logEl.appendChild(el);
                this.logEl.scrollTop = this.logEl.scrollHeight;
            }

            setPhaseUI(phase, text, btnActionText) {
                document.getElementById('hud-phase').innerText = text;
                const lines = document.querySelectorAll('.progress-line');
                lines.forEach((l,i) => i <= phase ? l.classList.add('active') : l.classList.remove('active'));
                
                this.btn.innerText = btnActionText;
                this.btn.className = 'btn-primary';
                if (phase >= 1 && phase <= 3) this.btn.classList.add('btn-action');
            }

            speak(text) {
                document.getElementById('speech').innerText = text;
                const avatar = document.getElementById('avatar');
                avatar.classList.remove('speaking');
                void avatar.offsetWidth; // trigger reflow
                avatar.classList.add('speaking');
            }

            createLabel(text, cls, vec3, camera) {
                const pos = vec3.clone().project(camera);
                const x = (pos.x * .5 + .5) * window.innerWidth - 360; // offset sidebar
                const y = (pos.y * -.5 + .5) * window.innerHeight;
                
                const el = document.createElement('div');
                el.className = `label-3d ${cls}`;
                el.innerText = text;
                el.style.left = `${x}px`; el.style.top = `${y}px`;
                this.labels.appendChild(el);
                if(cls.includes('label-hit')) setTimeout(() => el.remove(), 600);
                return el;
            }
        }

        // ==========================================
        // MOTOR 3D (Escena Minimalista)
        // ==========================================
        class Viewport3D {
            constructor() {
                this.container = document.getElementById('canvas-container');
                this.scene = new THREE.Scene();
                // Fondo transparente para ver el radial-gradient de CSS
                this.camera = new THREE.PerspectiveCamera(40, this.container.clientWidth/this.container.clientHeight, 0.1, 10);
                this.camera.position.set(0, 0.5, 1.3);
                
                this.renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                this.renderer.setSize(this.container.clientWidth, this.container.clientHeight);
                this.renderer.shadowMap.enabled = true;
                this.renderer.shadowMap.type = THREE.PCFSoftShadowMap;
                this.container.appendChild(this.renderer.domElement);

                this.controls = new THREE.OrbitControls(this.camera, this.renderer.domElement);
                this.controls.target.set(0, 0.12, 0);
                this.controls.enablePan = false;
                this.controls.minDistance = 0.5; this.controls.maxDistance = 2.5;
                this.controls.maxPolarAngle = Math.PI/2 - 0.02;

                this.clock = new THREE.Clock();
                this.setupStudio();
                this.buildMeshes();

                window.addEventListener('resize', () => {
                    this.camera.aspect = this.container.clientWidth/this.container.clientHeight;
                    this.camera.updateProjectionMatrix();
                    this.renderer.setSize(this.container.clientWidth, this.container.clientHeight);
                });

                this.renderLoop = this.renderLoop.bind(this);
                requestAnimationFrame(this.renderLoop);
            }

            setupStudio() {
                this.scene.add(new THREE.AmbientLight(0xffffff, 0.8));
                
                const mainLight = new THREE.DirectionalLight(0xffffff, 0.5);
                mainLight.position.set(1, 2, 1);
                mainLight.castShadow = true;
                mainLight.shadow.mapSize.set(2048, 2048);
                mainLight.shadow.bias = -0.0005;
                this.scene.add(mainLight);

                const backLight = new THREE.DirectionalLight(0xe2e8f0, 0.4);
                backLight.position.set(-1, 1, -1);
                this.scene.add(backLight);
            }

            buildMeshes() {
                // Placa Base Elegante (Metal cepillado mate)
                const plate = new THREE.Mesh(
                    new THREE.BoxGeometry(0.8, 0.01, 0.8),
                    new THREE.MeshStandardMaterial({color: 0xeeeeee, roughness: 0.6, metalness: 0.3})
                );
                plate.position.y = -0.005;
                plate.receiveShadow = true;
                this.scene.add(plate);

                // Grid sutil
                const grid = new THREE.GridHelper(0.8, 16, 0xcbd5e1, 0xcbd5e1);
                grid.position.y = 0.001;
                grid.material.transparent = true; grid.material.opacity = 0.5;
                this.scene.add(grid);

                // 1. MOLDE (Abierto, Radio base 0.1)
                const moldGeo = new THREE.CylinderGeometry(MOLD.R_TOP, MOLD.R_BASE, MOLD.H, 64, 1, true);
                this.moldMat = new THREE.MeshStandardMaterial({ color: 0xb0bec5, roughness: 0.4, metalness: 0.6, side: THREE.DoubleSide, transparent: true });
                this.mold = new THREE.Mesh(moldGeo, this.moldMat);
                this.mold.position.y = MOLD.H/2;
                this.mold.castShadow = true;
                
                // Asas del molde
                const handleGeo = new THREE.TorusGeometry(0.015, 0.003, 8, 24, Math.PI);
                const h1 = new THREE.Mesh(handleGeo, this.moldMat); h1.position.set(0.08, -0.05, 0); h1.rotation.set(0, Math.PI/2, -Math.PI/2);
                const h2 = new THREE.Mesh(handleGeo, this.moldMat); h2.position.set(-0.08, -0.05, 0); h2.rotation.set(0, Math.PI/2, Math.PI/2);
                this.mold.add(h1, h2);
                this.scene.add(this.mold);

                // 2. HORMIGÓN (Cerrado, Radio base 0.099 para evitar z-fighting)
                this.concGeo = new THREE.CylinderGeometry(CONC.R_TOP, CONC.R_BASE, CONC.H, 64, 32);
                this.concGeo.translate(0, CONC.H/2, 0); // Pivot en Y=0
                this.concMat = new THREE.MeshStandardMaterial({ color: 0x95a5a6, roughness: 0.9, flatShading: true });
                this.concrete = new THREE.Mesh(this.concGeo, this.concMat);
                this.concrete.castShadow = true; this.concrete.receiveShadow = true;
                this.scene.add(this.concrete);
                
                this.origVerts = new Float32Array(this.concGeo.attributes.position.array);
                this.setFill(0); // Iniciar vacío

                // 3. VARILLA CONCEPTUAL (Indicador visual esquemático)
                this.rodGroup = new THREE.Group();
                const rodLine = new THREE.Mesh(
                    new THREE.CylinderGeometry(0.002, 0.002, 0.5),
                    new THREE.MeshBasicMaterial({color: 0x3498db, transparent: true, opacity: 0.6})
                );
                rodLine.position.y = 0.25;
                const impactRing = new THREE.Mesh(
                    new THREE.RingGeometry(0.005, 0.01, 16),
                    new THREE.MeshBasicMaterial({color: 0x3498db, side: THREE.DoubleSide, transparent: true})
                );
                impactRing.rotation.x = -Math.PI/2;
                this.rodGroup.add(rodLine, impactRing);
                this.rodGroup.visible = false;
                this.scene.add(this.rodGroup);

                // 4. REGLA (Lineas)
                this.ruler = new THREE.Group();
                const lineMat = new THREE.LineBasicMaterial({color: 0x2c3e50});
                const pts = [new THREE.Vector3(0,0,0), new THREE.Vector3(0,0.35,0)];
                for(let y=0; y<=0.35; y+=0.05) pts.push(new THREE.Vector3(0,y,0), new THREE.Vector3(0.01,y,0));
                pts.push(new THREE.Vector3(-0.1, MOLD.H, 0), new THREE.Vector3(0, MOLD.H, 0)); // Brazo superior
                this.ruler.add(new THREE.LineSegments(new THREE.BufferGeometry().setFromPoints(pts), lineMat));
                this.ruler.position.set(0.18, 0, 0);
                this.ruler.visible = false;
                this.scene.add(this.ruler);
            }

            setFill(percent) {
                const hTarget = CONC.H * percent;
                const pos = this.concGeo.attributes.position;
                
                for(let i=0; i<pos.count; i++) {
                    const oY = this.origVerts[i*3+1];
                    if (percent === 0) {
                        pos.setY(i, 0); pos.setX(i, 0); pos.setZ(i, 0);
                    } else if (oY > hTarget) {
                        // Bajar vértice al target
                        pos.setY(i, hTarget);
                        // Ajustar radio al nuevo nivel
                        const factor = hTarget / CONC.H;
                        const rAtTarget = CONC.R_BASE - (CONC.R_BASE - CONC.R_TOP) * factor;
                        const oX = this.origVerts[i*3];
                        const oZ = this.origVerts[i*3+2];
                        const mag = Math.sqrt(oX*oX + oZ*oZ);
                        const angle = Math.atan2(oZ, oX);
                        
                        // Ratio radial original
                        const maxRAtOrigY = CONC.R_BASE - (CONC.R_BASE - CONC.R_TOP) * (oY/CONC.H);
                        const normR = mag / maxRAtOrigY;
                        
                        pos.setX(i, Math.cos(angle) * rAtTarget * normR);
                        pos.setZ(i, Math.sin(angle) * rAtTarget * normR);
                    } else {
                        pos.setY(i, oY); pos.setX(i, this.origVerts[i*3]); pos.setZ(i, this.origVerts[i*3+2]);
                    }
                }
                pos.needsUpdate = true;
                this.concGeo.computeVertexNormals();
            }

            async conceptualHit(height) {
                const r = CONC.R_BASE - (CONC.R_BASE - CONC.R_TOP) * (height/CONC.H);
                const angle = Math.random() * Math.PI*2;
                const d = Math.random() * (r * 0.8);
                const x = Math.cos(angle)*d, z = Math.sin(angle)*d;

                this.rodGroup.position.set(x, height, z);
                this.rodGroup.visible = true;
                
                // Animacion simple de impacto
                const ring = this.rodGroup.children[1];
                ring.scale.set(0.1, 0.1, 0.1);
                ring.material.opacity = 1.0;
                this.rodGroup.children[0].position.y = 0.5; // Arriba

                // Baja línea
                let t = 0;
                while(t < 0.1) {
                    t += this.clock.getDelta();
                    this.rodGroup.children[0].position.y = 0.5 - (0.25 * (t/0.1));
                    await wait(16);
                }
                
                // Expande anillo (impacto)
                t = 0;
                while(t < 0.2) {
                    t += this.clock.getDelta();
                    const s = 0.1 + (t/0.2)*2.0;
                    ring.scale.set(s,s,s);
                    ring.material.opacity = 1.0 - (t/0.2);
                    this.rodGroup.children[0].position.y = 0.25 + (0.25 * (t/0.2)); // Sube línea
                    await wait(16);
                }
                this.rodGroup.visible = false;
                return new THREE.Vector3(x, height, z);
            }

            async animateDesmoldeYAsiento(speed, res) {
                this.setFill(1.0);
                const basePos = new Float32Array(this.concGeo.attributes.position.array);
                
                // 1. Desmolde
                let t=0;
                while(t < speed) {
                    t += this.clock.getDelta();
                    this.mold.position.y = (MOLD.H/2) + (0.35 * (t/speed));
                    this.moldMat.opacity = 1.0 - (t/speed);
                    await wait(16);
                }
                this.mold.visible = false;

                // 2. Slump Reológico
                t = 0; const slumpTime = 2.0;
                while(t < slumpTime) {
                    t += this.clock.getDelta();
                    const pr = 1.0 - Math.exp(-t * 2.5);
                    const currSlump = res.slumpM * pr;
                    const pos = this.concGeo.attributes.position;
                    const H = CONC.H;
                    const currH = Math.max(0.01, H - currSlump);

                    for(let i=0; i<pos.count; i++) {
                        const oy = basePos[i*3+1], ox = basePos[i*3], oz = basePos[i*3+2];
                        const ny = oy / H;
                        
                        let newY = Math.max(0, oy - (ny * currSlump));
                        const exp = Math.sqrt(H / currH);
                        const bulge = Math.sin(ny * Math.PI) * currSlump * 0.4;
                        let newX = ox * exp + Math.sign(ox) * bulge * (1-ny);
                        let newZ = oz * exp + Math.sign(oz) * bulge * (1-ny);

                        // Fallos
                        if (res.type === 'CORTADO' && ny > 0.5) newX += (ny-0.5) * currSlump * 1.2;
                        if (res.type === 'COLAPSO') {
                            newY -= Math.sin(ox*50)*Math.cos(oz*50) * currSlump * 0.2 * ny;
                            newX += Math.cos(ny*10) * currSlump * 0.8 * (1-ny);
                        }

                        pos.setY(i, newY); pos.setX(i, newX); pos.setZ(i, newZ);
                    }
                    pos.needsUpdate = true; this.concGeo.computeVertexNormals();
                    await wait(16);
                }
            }

            reset() {
                this.mold.position.y = MOLD.H/2;
                this.moldMat.opacity = 1.0;
                this.mold.visible = true;
                this.setFill(0);
                this.ruler.visible = false;
            }

            renderLoop() {
                this.controls.update();
                this.renderer.render(this.scene, this.camera);
                requestAnimationFrame(this.renderLoop);
            }
        }

        // ==========================================
        // CONTROLADOR GLOBAL (Lógica de Fases)
        // ==========================================
        class App {
            constructor() {
                this.ui = new UI();
                this.ctx = new Viewport3D();
                this.phase = PHASES.SETUP;
                this.strokes = 0;
                this.isAnimating = false;

                this.ui.btn.addEventListener('click', () => this.advancePhase());
                document.getElementById('btn-reset').addEventListener('click', () => this.resetSim());
            }

            async advancePhase() {
                if(this.isAnimating) return;
                
                switch(this.phase) {
                    case PHASES.SETUP:
                        document.querySelectorAll('input[type=range]').forEach(i => i.disabled=true);
                        this.phase = PHASES.L1; this.strokes = 0;
                        this.ui.setPhaseUI(1, 'LLENADO CAPA 1', 'COMPACTAR (VARILLA)');
                        this.ui.speak('Añadimos hormigón hasta 1/3 del molde. Procede a aplicar 25 golpes de varilla para compactar.');
                        this.ui.log('Vertido de la capa inferior (1/3).');
                        this.ctx.setFill(0.33);
                        break;
                        
                    case PHASES.L1: case PHASES.L2: case PHASES.L3:
                        this.isAnimating = true;
                        this.strokes++;
                        document.getElementById('hud-strokes').innerText = `${this.strokes} / 25`;
                        
                        let bH = this.phase===PHASES.L1 ? 0.33 : this.phase===PHASES.L2 ? 0.66 : 1.0;
                        let h = (bH * CONC.H) - (this.strokes*0.0004);
                        
                        const impactPos = await this.ctx.conceptualHit(h);
                        this.ctx.setFill(h/CONC.H);
                        this.ui.createLabel('+1', 'label-hit', impactPos, this.ctx.camera);

                        if(this.strokes >= 25) {
                            this.ui.log(`Compactación completa capa ${this.phase}.`, 'success');
                            if(this.phase === PHASES.L1) {
                                this.phase = PHASES.L2; this.strokes = 0;
                                this.ctx.setFill(0.66);
                                this.ui.setPhaseUI(2, 'LLENADO CAPA 2', 'COMPACTAR (VARILLA)');
                                this.ui.speak('Segunda capa al 2/3. Los golpes deben penetrar ligeramente la capa inferior.');
                            } else if(this.phase === PHASES.L2) {
                                this.phase = PHASES.L3; this.strokes = 0;
                                this.ctx.setFill(1.05); // Rebosando
                                this.ui.setPhaseUI(3, 'LLENADO CAPA 3', 'COMPACTAR (VARILLA)');
                                this.ui.speak('Capa superior rebosando. Evita que el nivel baje del borde durante la compactación.');
                            } else {
                                this.phase = PHASES.STRIKE;
                                this.ui.setPhaseUI(4, 'ENRASE SUPERFICIAL', 'ENRASAR MOLDE');
                                this.ui.speak('Perfecto. Ahora elimina el exceso de hormigón enrasando la superficie con la varilla.');
                            }
                        }
                        this.isAnimating = false;
                        break;
                        
                    case PHASES.STRIKE:
                        this.ctx.setFill(1.0); // 300mm exactos
                        this.phase = PHASES.LIFT;
                        this.ui.setPhaseUI(5, 'IZADO DEL MOLDE', 'DESMOLDAR');
                        this.ui.speak('Molde nivelado. Realiza la elevación vertical del cono en el tiempo estipulado.');
                        this.ui.log('Superficie enrasada matemáticamente a 300mm.');
                        break;

                    case PHASES.LIFT:
                        this.isAnimating = true;
                        this.ui.btn.disabled = true;
                        this.ui.log('Elevando molde. Procesando reología física...', 'warning');
                        
                        const speed = parseFloat(document.getElementById('param-speed').value);
                        this.res = PhysicsCore.analyze(
                            parseFloat(document.getElementById('param-wc').value),
                            parseFloat(document.getElementById('param-agg').value),
                            parseFloat(document.getElementById('param-adit').value),
                            speed
                        );

                        await this.ctx.animateDesmoldeYAsiento(speed, this.res);
                        
                        this.phase = PHASES.RESULT;
                        this.showReport();
                        this.isAnimating = false;
                        break;
                }
            }

            showReport() {
                this.ui.setPhaseUI(6, 'MEDICIÓN Y RESULTADOS', 'ENSAYO FINALIZADO');
                this.ui.speak('El hormigón se ha asentado. Examina el informe técnico para determinar la viabilidad de la mezcla.');
                
                // Labels 3D (Regla)
                this.ctx.ruler.visible = true;
                for(let y=0; y<=0.3; y+=0.1) {
                    this.ui.createLabel(`${Math.round(y*1000)}`, 'label-tick', new THREE.Vector3(0.2, y, 0), this.ctx.camera);
                }

                // Animación Slump
                let curSlump = 0;
                let slumpHUD = document.getElementById('hud-slump');
                let slump3D = this.ui.createLabel('0', 'label-slump', new THREE.Vector3(0.05, CONC.H - (this.res.slumpM/2), 0), this.ctx.camera);
                
                let inter = setInterval(() => {
                    curSlump += this.res.slumpMM / 20;
                    if(curSlump >= this.res.slumpMM) { curSlump = this.res.slumpMM; clearInterval(inter); }
                    slumpHUD.innerText = curSlump.toFixed(1);
                    slump3D.innerText = `-${curSlump.toFixed(1)} mm`;
                }, 40);

                // Llenar Modal
                document.getElementById('res-val-big').innerText = `${this.res.slumpMM.toFixed(1)} mm`;
                document.getElementById('res-wc-used').innerText = document.getElementById('param-wc').value;
                
                const badge = document.getElementById('res-type-badge');
                badge.className = `res-type-badge type-${this.res.type}`;
                badge.innerText = `ASIENTO ${this.res.type}`;

                let cls = 'S1 (Seca)'; let desc = 'Hormigón apto para firmes y pavimentos compactados con rodillo o vibración de alta energía.';
                if(this.res.slumpMM >= 40 && this.res.slumpMM < 90) { cls = 'S2 (Plástica)'; desc = 'Adecuado para cimentaciones (zapatas, losas) y muros con armado normal.'; }
                else if(this.res.slumpMM >= 90 && this.res.slumpMM < 150) { cls = 'S3 (Blanda)'; desc = 'Hormigón apto para pilares y forjados estructurales convencionales. Requiere vibrado.'; }
                else if(this.res.slumpMM >= 150 && this.res.slumpMM <= 210) { cls = 'S4 (Fluida)'; desc = 'Adecuado para bombeo continuo y elementos con alta densidad de armado.'; }
                else if(this.res.slumpMM > 210) { cls = 'S5 (Líquida)'; desc = 'Solo recomendado bajo diseño de Hormigón Autocompactante (HAC). Riesgo de segregación.'; }
                
                if(this.res.type !== 'VERDADERO') desc = 'Ensayo técnico no válido. La deformación asimétrica invalida la medición. Es necesario repetir el proceso de laboratorio.';

                document.getElementById('res-class').innerText = cls;
                document.getElementById('res-interp').innerText = desc;

                setTimeout(() => document.getElementById('modal-results').classList.add('active'), 1200);
            }

            resetSim() {
                document.getElementById('modal-results').classList.remove('active');
                this.phase = PHASES.SETUP;
                this.strokes = 0;
                document.querySelectorAll('input[type=range]').forEach(i => i.disabled=false);
                
                this.ctx.reset();
                this.ui.labels.innerHTML = '';
                document.getElementById('hud-strokes').innerText = '0 / 25';
                document.getElementById('hud-slump').innerText = '--';
                this.ui.btn.disabled = false;
                
                this.ui.setPhaseUI(0, 'Preparación', 'INICIAR ENSAYO');
                this.ui.log('Área de trabajo limpia y herramientas preparadas.', 'info');
                this.ui.speak('Parámetros listos. Verifica la configuración de la mezcla en el panel lateral y pulsa "Iniciar Ensayo".');
            }
        }

        // Init
        window.onload = () => { window.app = new App(); };
    </script>
</body>
</html>
